<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeFi TVL Growth Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e4e4e4;
            padding: 20px;
            padding-top: 80px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Navigation Bar */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 52, 96, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            padding: 0 20px;
        }

        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        .navbar-brand {
            font-size: 1.2rem;
            font-weight: bold;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .navbar-links {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #e4e4e4;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #00d4ff;
        }

        .nav-link .nav-icon {
            margin-right: 6px;
        }

        header {
            text-align: center;
            padding: 40px 0;
        }

        header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        header p {
            color: #888;
            font-size: 1.1rem;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .timeframe-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .timeframe-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .timeframe-btn.active {
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            font-weight: bold;
        }

        .refresh-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            scroll-margin-top: 80px;
        }

        .section h2 {
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1.5rem;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #888;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0, 0, 0, 0.3);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            color: #00d4ff;
            user-select: none;
            position: relative;
        }

        th.sortable {
            cursor: pointer;
            padding-right: 25px;
        }

        th.sortable:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 8px;
            opacity: 0.3;
            font-size: 0.9rem;
        }

        th.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
        }

        th.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .rank {
            font-weight: bold;
            color: #7b2cbf;
            width: 50px;
        }

        .protocol-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .protocol-name a {
            color: #e4e4e4;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .protocol-name a:hover {
            color: #00d4ff;
        }

        .protocol-logo {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            object-fit: contain;
        }

        .tvl {
            font-weight: 600;
        }

        .change {
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 6px;
            display: inline-block;
        }

        .change.positive {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .change.negative {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .change.neutral {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .chains-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            max-width: 220px;
        }

        .chain-tag {
            background: rgba(123, 44, 191, 0.3);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .category-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-icon {
            font-size: 1.2rem;
        }

        .category-link {
            color: #e4e4e4;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .category-link:hover {
            color: #00d4ff;
        }

        .protocol-count {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            border-radius: 8px;
        }

        .retry-btn {
            margin-top: 15px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card .value {
            font-size: 1.6rem;
            font-weight: bold;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card .label {
            color: #888;
            margin-top: 8px;
            font-size: 0.85rem;
        }

        .table-container {
            overflow-x: auto;
        }

        .last-updated {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-top: 20px;
        }

        footer {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        footer a {
            color: #00d4ff;
            text-decoration: none;
        }

        .tvl-bar-container {
            width: 100px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .tvl-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .tvl-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* Expandable rows */
        .expandable-row {
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .expandable-row:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .expandable-row td:first-child {
            position: relative;
            padding-left: 30px;
        }

        .expand-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: #00d4ff;
            transition: transform 0.2s ease;
        }

        .expandable-row.expanded .expand-icon {
            transform: translateY(-50%) rotate(90deg);
        }

        .expanded-content {
            display: none;
            background: rgba(0, 0, 0, 0.2);
        }

        .expanded-content.show {
            display: table-row;
        }

        .expanded-content td {
            padding: 0;
        }

        .sub-table-container {
            padding: 15px 20px 15px 40px;
        }

        .sub-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            overflow: hidden;
        }

        .sub-table th {
            background: rgba(0, 212, 255, 0.1);
            font-size: 0.75rem;
            padding: 10px 8px;
            color: #00d4ff;
        }

        .sub-table td {
            padding: 10px 8px;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sub-table tr:last-child td {
            border-bottom: none;
        }

        .sub-table .protocol-logo {
            width: 22px;
            height: 22px;
        }

        .sub-table-title {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sub-table-title strong {
            color: #00d4ff;
        }

        .no-data {
            color: #666;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }

        @media (max-width: 768px) {
            body {
                padding-top: 120px;
            }

            .navbar-content {
                flex-direction: column;
                height: auto;
                padding: 10px 0;
                gap: 10px;
            }

            .navbar-links {
                gap: 5px;
            }

            .nav-link {
                padding: 6px 10px;
                font-size: 0.8rem;
            }

            header h1 {
                font-size: 1.8rem;
            }

            th, td {
                padding: 10px 6px;
                font-size: 0.8rem;
            }

            .chains-list {
                max-width: 100px;
            }

            .protocol-logo {
                width: 22px;
                height: 22px;
            }

            .tvl-bar-container {
                width: 60px;
            }

            .sub-table-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-brand">DeFi TVL Tracker</div>
            <div class="navbar-links">
                <a href="#protocols-section" class="nav-link"><span class="nav-icon">üöÄ</span>Protocols</a>
                <a href="#categories-section" class="nav-link"><span class="nav-icon">üìä</span>Categories</a>
                <a href="#chains-section" class="nav-link"><span class="nav-icon">‚õìÔ∏è</span>Chains</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <header>
            <h1>DeFi TVL Growth Tracker</h1>
            <p>Track protocols, chains, and categories with the highest TVL growth</p>
        </header>

        <div class="controls">
            <button class="timeframe-btn active" data-timeframe="1d">24 Hours</button>
            <button class="timeframe-btn" data-timeframe="7d">7 Days</button>
            <button class="timeframe-btn" data-timeframe="30d">1 Month</button>
            <button class="refresh-btn" id="refreshBtn">‚Üª Refresh</button>
        </div>

        <div class="stats-row">
            <div class="stat-card">
                <div class="value" id="totalProtocols">-</div>
                <div class="label">Protocols (‚â•$1M)</div>
            </div>
            <div class="stat-card">
                <div class="value" id="totalChains">-</div>
                <div class="label">Chains (‚â•$10M)</div>
            </div>
            <div class="stat-card">
                <div class="value" id="totalCategories">-</div>
                <div class="label">Categories</div>
            </div>
            <div class="stat-card">
                <div class="value" id="topGrowth">-</div>
                <div class="label">Top Protocol Growth</div>
            </div>
            <div class="stat-card">
                <div class="value" id="topChainGrowth">-</div>
                <div class="label">Top Chain Growth</div>
            </div>
            <div class="stat-card">
                <div class="value" id="topCategoryGrowth">-</div>
                <div class="label">Top Category Growth</div>
            </div>
        </div>

        <div class="section" id="protocols-section">
            <h2><span class="section-icon">üöÄ</span> Top Growing Protocols (TVL ‚â• $1M)</h2>
            <div class="table-container" id="protocolsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading protocols...</p>
                </div>
            </div>
        </div>

        <div class="section" id="categories-section">
            <h2><span class="section-icon">üìä</span> Category Performance (Click to expand)</h2>
            <div class="table-container" id="categoriesContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading categories...</p>
                </div>
            </div>
        </div>

        <div class="section" id="chains-section">
            <h2><span class="section-icon">‚õìÔ∏è</span> Top Growing Chains (Click to expand)</h2>
            <div class="table-container" id="chainsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading chains...</p>
                </div>
            </div>
        </div>

        <p class="last-updated" id="lastUpdated"></p>

        <footer>
            <p>Data from <a href="https://defillama.com" target="_blank">DefiLlama API</a> ‚Ä¢ Built with ‚ù§Ô∏è for DeFi degens</p>
        </footer>
    </div>

    <script>
        // ============ CONFIGURATION ============
        const CONFIG = {
            PROTOCOL_MIN_TVL: 1_000_000,
            CHAIN_MIN_TVL: 10_000_000,
            TOP_RESULTS: 50,
            TOP_SUB_RESULTS: 5
        };

        // Category icons mapping
        const CATEGORY_ICONS = {
            'Dexes': 'üîÑ',
            'DEX': 'üîÑ',
            'Lending': 'üè¶',
            'CDP': 'üíµ',
            'Bridge': 'üåâ',
            'Derivatives': 'üìà',
            'Yield': 'üåæ',
            'Yield Aggregator': 'üåæ',
            'Liquid Staking': 'üíß',
            'Liquidity manager': 'üíß',
            'Services': 'üõ†Ô∏è',
            'Staking': 'ü•©',
            'Farm': 'üöú',
            'Reserve Currency': 'üí∞',
            'Algo-Stables': 'üî¢',
            'Insurance': 'üõ°Ô∏è',
            'Options': 'üìä',
            'Indexes': 'üìë',
            'Synthetics': 'üß™',
            'Gaming': 'üéÆ',
            'NFT Lending': 'üñºÔ∏è',
            'NFT Marketplace': 'üè™',
            'Payments': 'üí≥',
            'Privacy': 'üîí',
            'Launchpad': 'üöÄ',
            'Prediction Market': 'üéØ',
            'RWA': 'üè†',
            'RWA Lending': 'üè†',
            'Leveraged Farming': '‚ö°',
            'Cross Chain': 'üîó',
            'SoFi': 'üì±',
            'Oracle': 'üîÆ',
            'Other': 'üì¶'
        };

        // Chain name ‚Üí DefiLlama slug mapping
        const CHAIN_SLUGS = {
            'Ethereum': 'ethereum',
            'Tron': 'tron',
            'BSC': 'bsc',
            'BNB Chain': 'bsc',
            'Polygon': 'polygon',
            'Arbitrum': 'arbitrum',
            'Optimism': 'optimism',
            'Base': 'base',
            'Avalanche': 'avalanche',
            'Solana': 'solana',
            'Fantom': 'fantom',
            'zkSync Era': 'zksync-era',
            'Linea': 'linea',
            'Scroll': 'scroll',
            'Mantle': 'mantle',
            'Blast': 'blast',
            'Metis': 'metis',
            'Mode': 'mode',
            'Cronos': 'cronos',
            'Kava': 'kava',
            'Celo': 'celo',
            'Gnosis': 'gnosis',
            'Harmony': 'harmony',
            'Moonbeam': 'moonbeam',
            'Moonriver': 'moonriver',
            'Astar': 'astar',
            'Injective': 'injective',
            'Starknet': 'starknet',
            'Sui': 'sui',
            'Aptos': 'aptos',
            'Cardano': 'cardano',
            'TON': 'ton',
            'Near': 'near',
            'Cosmos': 'cosmos',
            'Osmosis': 'osmosis'
        };

        // ============ STATE ============
        let currentTimeframe = '1d';
        let rawProtocols = null;
        let rawChains = null;
        let isLoading = false;
        let expandedChains = new Set();
        let expandedCategories = new Set();

        const sortState = {
            protocols: { column: 'change', direction: 'desc' },
            chains: { column: 'change', direction: 'desc' },
            categories: { column: 'change', direction: 'desc' }
        };

        // ============ UTILITIES ============
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTVL(num) {
            if (!num || isNaN(num)) return '$0';
            if (num >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
            if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
            if (num >= 1e3) return `$${(num / 1e3).toFixed(2)}K`;
            return `$${num.toFixed(0)}`;
        }

        function formatPercent(num) {
            if (num === null || num === undefined || isNaN(num)) return 'N/A';
            const sign = num >= 0 ? '+' : '';
            return `${sign}${num.toFixed(2)}%`;
        }

        function getChangeClass(num) {
            if (num === null || num === undefined || isNaN(num)) return 'neutral';
            return num >= 0 ? 'positive' : 'negative';
        }

        function getChangeField(timeframe) {
            return timeframe === '1d' ? 'change_1d' : timeframe === '7d' ? 'change_7d' : 'change_1m';
        }

        function getCategoryIcon(category) {
            return CATEGORY_ICONS[category] || CATEGORY_ICONS['Other'];
        }

        function getCategorySlug(category) {
            return category.toLowerCase().replace(/\s+/g, '-').replace(/[^^a-z0-9-]/g, '');
        }

        // ============ DATA PROCESSING ============
        function processProtocols(protocols, timeframe) {
            const field = getChangeField(timeframe);
            return protocols
                .filter(p => p.tvl >= CONFIG.PROTOCOL_MIN_TVL && p[field] != null)
                .map(p => ({
                    name: p.name,
                    slug: p.slug,
                    logo: p.logo || 'https://icons.llama.fi/missing.png',
                    tvl: p.tvl,
                    chains: p.chains || [],
                    change: p[field],
                    category: p.category || 'Other'
                }));
        }

        function processChains(chains, timeframe) {
            const field = getChangeField(timeframe);
            return chains
                .filter(c => c.tvl >= CONFIG.CHAIN_MIN_TVL && c[field] != null)
                .map(c => ({
                    name: c.name,
                    slug: CHAIN_SLUGS[c.name] || c.name.toLowerCase().replace(/\s+/g, '-'),
                    tvl: c.tvl,
                    change: c[field],
                    tokenSymbol: c.tokenSymbol || '-'
                }));
        }

        function processCategories(protocols, timeframe) {
            const field = getChangeField(timeframe);
            const categoryMap = new Map();

            protocols
                .filter(p => p.tvl >= CONFIG.PROTOCOL_MIN_TVL && p[field] != null)
                .forEach(p => {
                    const category = p.category || 'Other';
                    
                    if (!categoryMap.has(category)) {
                        categoryMap.set(category, {
                            name: category,
                            totalTvl: 0,
                            weightedChangeSum: 0,
                            protocolCount: 0,
                            protocols: []
                        });
                    }

                    const cat = categoryMap.get(category);
                    cat.totalTvl += p.tvl;
                    cat.weightedChangeSum += p.tvl * p[field];
                    cat.protocolCount += 1;
                    cat.protocols.push(p.name);
                });

            return Array.from(categoryMap.values())
                .map(cat => ({
                    name: cat.name,
                    tvl: cat.totalTvl,
                    change: cat.totalTvl > 0 ? cat.weightedChangeSum / cat.totalTvl : 0,
                    protocolCount: cat.protocolCount,
                    topProtocols: cat.protocols.slice(0, 5)
                }))
                .filter(cat => cat.tvl > 0);
        }

        function getTopProtocolsForChain(chainName, limit = CONFIG.TOP_SUB_RESULTS) {
            if (!rawProtocols) return [];
            const field = getChangeField(currentTimeframe);
            
            return rawProtocols
                .filter(p => {
                    const chains = p.chains || [];
                    return chains.includes(chainName) && p.tvl >= CONFIG.PROTOCOL_MIN_TVL && p[field] != null;
                })
                .map(p => ({
                    name: p.name,
                    slug: p.slug,
                    logo: p.logo || 'https://icons.llama.fi/missing.png',
                    tvl: p.tvl,
                    change: p[field],
                    category: p.category || 'Other'
                }))
                .sort((a, b) => b.change - a.change)
                .slice(0, limit);
        }

        function getTopProtocolsForCategory(categoryName, limit = CONFIG.TOP_SUB_RESULTS) {
            if (!rawProtocols) return [];
            const field = getChangeField(currentTimeframe);
            
            return rawProtocols
                .filter(p => {
                    const category = p.category || 'Other';
                    return category === categoryName && p.tvl >= CONFIG.PROTOCOL_MIN_TVL && p[field] != null;
                })
                .map(p => ({
                    name: p.name,
                    slug: p.slug,
                    logo: p.logo || 'https://icons.llama.fi/missing.png',
                    tvl: p.tvl,
                    change: p[field],
                    category: p.category || 'Other'
                }))
                .sort((a, b) => b.change - a.change)
                .slice(0, limit);
        }

        // ============ SORTING ============
        function sortData(data, sortCol, sortDir) {
            return [...data].sort((a, b) => {
                let aVal = a[sortCol];
                let bVal = b[sortCol];

                if (sortCol === 'name' || sortCol === 'category') {
                    aVal = (aVal || '').toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                    if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
                    return 0;
                }

                aVal = aVal || 0;
                bVal = bVal || 0;
                return sortDir === 'asc' ? aVal - bVal : bVal - aVal;
            });
        }

        // ============ SUB-TABLE RENDERING ============
        function renderSubTable(protocols, title) {
            if (protocols.length === 0) {
                return `<div class="no-data">No protocols found with significant TVL change</div>`;
            }

            const rows = protocols.map((p, i) => `
                <tr>
                    <td class="rank">#${i + 1}</td>
                    <td>
                        <div class="protocol-name">
                            <img class="protocol-logo" src="${escapeHtml(p.logo)}" alt="${escapeHtml(p.name)}" onerror="this.onerror=null; this.src='https://icons.llama.fi/missing.png'">
                            <a href="https://defillama.com/protocol/${escapeHtml(p.slug)}" target="_blank">${escapeHtml(p.name)}</a>
                        </div>
                    </td>
                    <td class="tvl">${formatTVL(p.tvl)}</td>
                    <td><span class="change ${getChangeClass(p.change)}">${formatPercent(p.change)}</span></td>
                    <td>${escapeHtml(p.category)}</td>
                </tr>
            `).join('');

            return `
                <div class="sub-table-title">
                    <span>üìà</span> Top 5 TVL Gainers in <strong>${escapeHtml(title)}</strong>
                </div>
                <table class="sub-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Protocol</th>
                            <th>TVL</th>
                            <th>Change</th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        // ============ RENDERING ============
        function renderCategoriesTable(data, sortCol, sortDir) {
            const sorted = sortData(data, sortCol, sortDir);
            const maxTvl = Math.max(...sorted.map(c => c.tvl));

            if (sorted.length === 0) {
                return '<div class="loading"><p>No categories found.</p></div>';
            }

            const rows = sorted.map((c, i) => {
                const barWidth = maxTvl > 0 ? (c.tvl / maxTvl) * 100 : 0;
                const isExpanded = expandedCategories.has(c.name);
                const topProtocols = isExpanded ? getTopProtocolsForCategory(c.name) : [];
                
                return `
                    <tr class="expandable-row ${isExpanded ? 'expanded' : ''}" data-category="${escapeHtml(c.name)}">
                        <td class="rank">
                            <span class="expand-icon">‚ñ∂</span>
                            #${i + 1}
                        </td>
                        <td>
                            <div class="category-name">
                                <span class="category-icon">${getCategoryIcon(c.name)}</span>
                                <a class="category-link" href="https://defillama.com/protocols/${getCategorySlug(c.name)}" target="_blank" onclick="event.stopPropagation()">
                                    ${escapeHtml(c.name)}
                                </a>
                            </div>
                        </td>
                        <td>
                            <div class="tvl-cell">
                                <span class="tvl">${formatTVL(c.tvl)}</span>
                                <div class="tvl-bar-container">
                                    <div class="tvl-bar" style="width: ${barWidth}%"></div>
                                </div>
                            </div>
                        </td>
                        <td><span class="change ${getChangeClass(c.change)}">${formatPercent(c.change)}</span></td>
                        <td><span class="protocol-count">${c.protocolCount}</span></td>
                    </tr>
                    <tr class="expanded-content ${isExpanded ? 'show' : ''}" data-category-content="${escapeHtml(c.name)}">
                        <td colspan="5">
                            <div class="sub-table-container">
                                ${isExpanded ? renderSubTable(topProtocols, c.name) : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <table id="categoriesTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th class="sortable ${sortCol === 'name' ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}" data-col="name">Category</th>
                            <th class="sortable ${sortCol === 'tvl' ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}" data-col="tvl">Total TVL</th>
                            <th class="sortable ${sortCol === 'change' ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}" data-col="change">Avg Change</th>
                            <th class="sortable ${sortCol === 'protocolCount' ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}" data-col="protocolCount">Protocols</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function renderProtocolsTable(data, sortCol, sortDir) {
            const sorted = sortData(data, sortCol, sortDir).slice(0, CONFIG.TOP_RESULTS);

            if (sorted.length === 0) {
                return '<div class="loading"><p>No protocols found matching criteria.</p></div>';
            }

            const rows = sorted.map((p, i) => `
                <tr>
                    <td class="rank">#${i + 1}</td>
                    <td>
                        <div class="protocol-name">
                            <img class="protocol-logo" src="${escapeHtml(p.logo)}" alt="${escapeHtml(p.name)}" onerror="this.onerror=null; this.src='https://icons.llama.fi/missing.png'">
                            <a href="https://defillama.com/protocol/${escapeHtml(p.slug)}" target="_blank">${escapeHtml(p.name)}</a>
                        </div>
                    </td>
                    <td class="tvl">${formatTVL(p.tvl)}</td>
                    <td><span class="change ${getChangeClass(p.change)}">${formatPercent(p.change)}</span></td>
                    <td>
                        <div class="chains-list">
                            ${p.chains.slice(0, 3).map(c => `<span class="chain-tag">${escapeHtml(c)}</span>`).join('')}
                            ${p.chains.length > 3 ? `<span class="chain-tag">+${p.chains.length - 3}</span>` : ''}
                        </div>
                    </td>
                    <td>${escapeHtml(p.category)}</td>
                </tr>
            `).join('');

            return `
                <table id="protocolsTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th class="sortable ${sortCol === 'name' ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}" data-col="name">Protocol</th>
                            <th class="sortable ${sortCol === 'tvl' ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}" data-col="tvl">TVL</th>
                            <th class="sortable ${sortCol === 'change' ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}" data-col="change">Change</th>
                            <th>Chains</th>
                            <th class="sortable ${sortCol === 'category' ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}" data-col="category">Category</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function renderChainsTable(data, sortCol, sortDir) {
            const sorted = sortData(data, sortCol, sortDir).slice(0, CONFIG.TOP_RESULTS);

            if (sorted.length === 0) {
                return '<div class="loading"><p>No chains found matching criteria.</p></div>';
            }

            const rows = sorted.map((c, i) => {
                const isExpanded = expandedChains.has(c.name);
                const topProtocols = isExpanded ? getTopProtocolsForChain(c.name) : [];
                
                return `
                    <tr class="expandable-row ${isExpanded ? 'expanded' : ''}" data-chain="${escapeHtml(c.name)}">
                        <td class="rank">
                            <span class="expand-icon">‚ñ∂</span>
                            #${i + 1}
                        </td>
                        <td><a href="https://defillama.com/chain/${escapeHtml(c.slug)}" target="_blank" onclick="event.stopPropagation()">${escapeHtml(c.name)}</a></td>
                        <td class="tvl">${formatTVL(c.tvl)}</td>
                        <td><span class="change ${getChangeClass(c.change)}">${formatPercent(c.change)}</span></td>
                        <td>${escapeHtml(c.tokenSymbol)}</td>
                    </tr>
                    <tr class="expanded-content ${isExpanded ? 'show' : ''}" data-chain-content="${escapeHtml(c.name)}">
                        <td colspan="5">
                            <div class="sub-table-container">
                                ${isExpanded ? renderSubTable(topProtocols, c.name) : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <table id="chainsTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th class="sortable ${sortCol === 'name' ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}" data-col="name">Chain</th>
                            <th class="sortable ${sortCol === 'tvl' ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}" data-col="tvl">TVL</th>
                            <th class="sortable ${sortCol === 'change' ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}" data-col="change">Change</th>
                            <th>Token</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function updateStats(protocols, chains, categories) {
            const sortedProtocols = sortData(protocols, 'change', 'desc');
            const sortedChains = sortData(chains, 'change', 'desc');
            const sortedCategories = sortData(categories, 'change', 'desc');

            document.getElementById('totalProtocols').textContent = protocols.length;
            document.getElementById('totalChains').textContent = chains.length;
            document.getElementById('totalCategories').textContent = categories.length;
            document.getElementById('topGrowth').textContent = sortedProtocols.length ? formatPercent(sortedProtocols[0].change) : '-';
            document.getElementById('topChainGrowth').textContent = sortedChains.length ? formatPercent(sortedChains[0].change) : '-';
            document.getElementById('topCategoryGrowth').textContent = sortedCategories.length ? formatPercent(sortedCategories[0].change) : '-';
        }

        // ============ EVENT HANDLERS ============
        document.getElementById('categoriesContainer').addEventListener('click', e => {
            // Handle sorting
            const th = e.target.closest('th.sortable');
            if (th) {
                const col = th.dataset.col;
                const isSameColumn = sortState.categories.column === col;
                sortState.categories.direction = isSameColumn && sortState.categories.direction === 'desc' ? 'asc' : 'desc';
                sortState.categories.column = col;
                renderAll();
                return;
            }

            // Handle row expansion
            const row = e.target.closest('.expandable-row');
            if (row && !e.target.closest('a')) {
                const category = row.dataset.category;
                if (expandedCategories.has(category)) {
                    expandedCategories.delete(category);
                } else {
                    expandedCategories.add(category);
                }
                renderAll();
            }
        });

        document.getElementById('protocolsContainer').addEventListener('click', e => {
            const th = e.target.closest('th.sortable');
            if (!th) return;

            const col = th.dataset.col;
            const isSameColumn = sortState.protocols.column === col;
            sortState.protocols.direction = isSameColumn && sortState.protocols.direction === 'desc' ? 'asc' : 'desc';
            sortState.protocols.column = col;
            renderAll();
        });

        document.getElementById('chainsContainer').addEventListener('click', e => {
            // Handle sorting
            const th = e.target.closest('th.sortable');
            if (th) {
                const col = th.dataset.col;
                const isSameColumn = sortState.chains.column === col;
                sortState.chains.direction = isSameColumn && sortState.chains.direction === 'desc' ? 'asc' : 'desc';
                sortState.chains.column = col;
                renderAll();
                return;
            }

            // Handle row expansion
            const row = e.target.closest('.expandable-row');
            if (row && !e.target.closest('a')) {
                const chain = row.dataset.chain;
                if (expandedChains.has(chain)) {
                    expandedChains.delete(chain);
                } else {
                    expandedChains.add(chain);
                }
                renderAll();
            }
        });

        // Smooth scroll for navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                const target = document.getElementById(targetId);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // ============ MAIN RENDER ============
        function renderAll() {
            if (!rawProtocols || !rawChains) return;

            const processedProtocols = processProtocols(rawProtocols, currentTimeframe);
            const processedChains = processChains(rawChains, currentTimeframe);
            const processedCategories = processCategories(rawProtocols, currentTimeframe);

            document.getElementById('protocolsContainer').innerHTML = renderProtocolsTable(
                processedProtocols,
                sortState.protocols.column,
                sortState.protocols.direction
            );

            document.getElementById('categoriesContainer').innerHTML = renderCategoriesTable(
                processedCategories,
                sortState.categories.column,
                sortState.categories.direction
            );

            document.getElementById('chainsContainer').innerHTML = renderChainsTable(
                processedChains,
                sortState.chains.column,
                sortState.chains.direction
            );

            updateStats(processedProtocols, processedChains, processedCategories);
        }

        // ============ DATA LOADING ============
        async function loadData(forceRefresh = false) {
            if (isLoading) return;

            const pc = document.getElementById('protocolsContainer');
            const catC = document.getElementById('categoriesContainer');
            const cc = document.getElementById('chainsContainer');
            const refreshBtn = document.getElementById('refreshBtn');

            try {
                isLoading = true;
                refreshBtn.disabled = true;
                refreshBtn.textContent = '‚Üª Loading...';

                if (!rawProtocols || !rawChains || forceRefresh) {
                    const loadingHtml = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading data from DefiLlama...</p>
                        </div>
                    `;
                    pc.innerHTML = catC.innerHTML = cc.innerHTML = loadingHtml;

                    // Clear expanded states on refresh
                    expandedChains.clear();
                    expandedCategories.clear();

                    const [protocolsResponse, chainsResponse] = await Promise.all([
                        fetch('https://api.llama.fi/protocols'),
                        fetch('https://api.llama.fi/v2/chains')
                    ]);

                    if (!protocolsResponse.ok || !chainsResponse.ok) {
                        throw new Error('API request failed');
                    }

                    rawProtocols = await protocolsResponse.json();
                    rawChains = await chainsResponse.json();
                }

                renderAll();
                document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;

            } catch (err) {
                console.error('Load error:', err);
                const errorHtml = `
                    <div class="error">
                        <p>Failed to load data: ${escapeHtml(err.message)}</p>
                        <button class="retry-btn" onclick="loadData(true)">‚Üª Retry</button>
                    </div>
                `;
                pc.innerHTML = catC.innerHTML = cc.innerHTML = errorHtml;
            } finally {
                isLoading = false;
                refreshBtn.disabled = false;
                refreshBtn.textContent = '‚Üª Refresh';
            }
        }

        // ============ REFRESH BUTTON ============
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadData(true);
        });

        // ============ TIMEFRAME SWITCH ============
        document.querySelectorAll('.timeframe-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTimeframe = btn.dataset.timeframe;

                // Reset sort state when changing timeframe
                sortState.protocols = { column: 'change', direction: 'desc' };
                sortState.chains = { column: 'change', direction: 'desc' };
                sortState.categories = { column: 'change', direction: 'desc' };

                renderAll();
            });
        });

        // ============ INIT ============
        loadData();
    </script>
</body>
</html>
