<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeFi TVL Growth Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e4e4e4;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(123, 44, 191, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 32px 0 16px;
        }

        header h1 {
            font-size: 2.7rem;
            font-weight: 800;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        header p {
            color: #888;
            font-size: 1.15rem;
            margin-bottom: 12px;
        }

        .header-controls {
            display: flex;
            justify-content: center;
            margin-top: 12px;
        }

        .refresh-btn {
            padding: 14px 32px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            color: #fff;
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(123, 44, 191, 0.5);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(123, 44, 191, 0.7);
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Stats */
        .stats-grid {
            margin: 32px 0 28px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 18px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(14px);
            border-radius: 12px;
            padding: 22px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3), 0 0 25px rgba(0, 212, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.45), 0 0 35px rgba(0, 212, 255, 0.2);
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card .label {
            color: #999;
            margin-top: 8px;
            font-size: 0.92rem;
        }

        .stat-card .top-name {
            color: #00d4ff;
            font-weight: 700;
            margin-top: 6px;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Layout */
        .top-sections-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 26px;
            margin-bottom: 26px;
        }

        .section {
            height: calc(100vh - 360px);
            min-height: 520px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 24px;
            padding-right: 16px;
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35), 0 0 30px rgba(0, 212, 255, 0.12);
            transition: all 0.3s ease;
        }

        .section:hover {
            box-shadow: 0 14px 50px rgba(0, 0, 0, 0.5), 0 0 40px rgba(0, 212, 255, 0.22);
            border-color: rgba(0, 212, 255, 0.4);
        }

        #categories-section {
            height: calc(100vh - 360px);
            min-height: 520px;
        }

        /* Scrollbars */
        .section::-webkit-scrollbar {
            width: 10px;
        }

        .section::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.06);
            border-radius: 6px;
        }

        .section::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.6);
            border-radius: 6px;
        }

        .section::-webkit-scrollbar-thumb:hover {
            background: #00d4ff;
        }

        /* Headers & Controls */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.25);
            flex-wrap: wrap;
            gap: 12px;
        }

        .section-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-icon {
            font-size: 1.5rem;
        }

        .section-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .timeframe-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.12);
            transition: all 0.3s ease;
        }

        .timeframe-btn:hover {
            background: rgba(255, 255, 255, 0.18);
            transform: translateY(-1px);
        }

        .timeframe-btn.active {
            background: linear-gradient(135deg, #00d4ff28, #7b2cbf40);
            border: 1px solid rgba(0, 212, 255, 0.5);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: #888;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0, 0, 0, 0.45);
            color: #00d4ff;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.8px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.4);
            user-select: none;
            position: relative;
        }

        th.sortable {
            cursor: pointer;
            padding-right: 25px;
        }

        th.sortable:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 8px;
            opacity: 0.3;
            font-size: 0.9rem;
        }

        th.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
        }

        th.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .rank {
            font-weight: bold;
            color: #7b2cbf;
            width: 60px;
        }

        .tvl {
            font-weight: 600;
        }

        .change {
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 6px;
            display: inline-block;
        }

        .change.positive {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .change.negative {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .change.neutral {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        /* Expandable rows */
        .expandable-row {
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .expandable-row:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .expandable-row:focus {
            outline: 2px solid #00d4ff;
            outline-offset: -2px;
        }

        .expandable-row td:first-child {
            position: relative;
            padding-left: 28px;
        }

        .expand-icon {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            color: #00d4ff;
            transition: transform 0.2s ease;
            font-weight: bold;
        }

        .expandable-row.expanded .expand-icon {
            transform: translateY(-50%) rotate(90deg);
        }

        .expanded-content {
            display: none;
            background: rgba(0, 0, 0, 0.2);
        }

        .expanded-content.show {
            display: table-row;
        }

        .expanded-content td {
            padding: 0;
        }

        .sub-table-container {
            padding: 15px 20px 15px 40px;
        }

        .sub-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            overflow: hidden;
        }

        .sub-table th {
            background: rgba(0, 212, 255, 0.1);
            font-size: 0.75rem;
            padding: 10px 8px;
            color: #00d4ff;
        }

        .sub-table td {
            padding: 10px 8px;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sub-table tr:last-child td {
            border-bottom: none;
        }

        .sub-table-title {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sub-table-title strong {
            color: #00d4ff;
        }

        .no-data {
            color: #666;
            font-style: italic;
            padding: 30px;
            text-align: center;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            border-radius: 8px;
        }

        .retry-btn {
            margin-top: 15px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .last-updated {
            text-align: center;
            color: #666;
            margin: 24px 0;
            font-size: 0.95rem;
        }

        footer {
            text-align: center;
            padding: 40px 0 20px;
            color: #666;
            font-size: 0.9rem;
        }

        footer a {
            color: #00d4ff;
            text-decoration: none;
        }

        /* Protocol/Chain specific styles */
        .protocol-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .protocol-name a,
        .chain-name a,
        .category-name a {
            color: #e4e4e4;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .protocol-name a:hover,
        .chain-name a:hover,
        .category-name a:hover {
            color: #00d4ff;
        }

        .protocol-logo {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            object-fit: contain;
        }

        .chains-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            max-width: 200px;
        }

        .chain-tag {
            background: rgba(123, 44, 191, 0.3);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .category-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-icon {
            font-size: 1.4rem;
        }

        .protocol-count {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .tvl-bar-container {
            width: 100px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }

        .tvl-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            border-radius: 4px;
            transition: width 0.4s ease;
        }

        @media (max-width: 1100px) {
            .top-sections-wrapper {
                grid-template-columns: 1fr;
            }

            .section,
            #categories-section {
                height: calc(100vh - 420px);
                min-height: 460px;
            }
        }

        @media (max-height: 900px) {
            .section,
            #categories-section {
                height: calc(100vh - 340px);
            }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            .stats-row {
                grid-template-columns: 1fr;
            }

            .top-sections-wrapper {
                gap: 20px;
            }

            .section {
                padding: 18px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .section-header h2 {
                font-size: 1.2rem;
            }

            th, td {
                padding: 10px 6px;
                font-size: 0.8rem;
            }

            .chains-list {
                max-width: 100px;
            }

            .protocol-logo {
                width: 22px;
                height: 22px;
            }

            .tvl-bar-container {
                width: 60px;
            }

            .sub-table-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DeFi TVL Growth Tracker</h1>
            <p>Real-time leaders in protocols, chains & categories</p>
            <div class="header-controls">
                <button class="refresh-btn" id="refreshBtn">‚Üª Refresh Data</button>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stats-row">
                <div class="stat-card">
                    <div class="value" id="totalProtocols">-</div>
                    <div class="label">Protocols Tracked (‚â•$1M TVL)</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="totalChains">-</div>
                    <div class="label">Chains Tracked (‚â•$10M TVL)</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="totalCategories">-</div>
                    <div class="label">Categories Tracked</div>
                </div>
            </div>
            <div class="stats-row">
                <div class="stat-card">
                    <div class="value" id="topGrowth">-</div>
                    <div class="label">Top Protocol Growth (24H)</div>
                    <div class="top-name" id="topProtocolName">-</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="topChainGrowth">-</div>
                    <div class="label">Top Chain Growth (24H)</div>
                    <div class="top-name" id="topChainName">-</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="topCategoryGrowth">-</div>
                    <div class="label">Top Category Growth (24H)</div>
                    <div class="top-name" id="topCategoryName">-</div>
                </div>
            </div>
        </div>

        <div class="top-sections-wrapper">
            <section class="section" id="protocols-section" aria-labelledby="protocols-heading">
                <div class="section-header">
                    <h2 id="protocols-heading"><span class="section-icon">üöÄ</span> Top Growing Protocols</h2>
                    <div class="section-controls" role="group" aria-label="Protocols timeframe selection">
                        <button class="timeframe-btn active" data-section="protocols" data-timeframe="1d" aria-pressed="true">24H</button>
                        <button class="timeframe-btn" data-section="protocols" data-timeframe="7d" aria-pressed="false">7D</button>
                        <button class="timeframe-btn" data-section="protocols" data-timeframe="30d" aria-pressed="false">1M</button>
                    </div>
                </div>
                <div class="table-container" id="protocolsContainer" role="region" aria-live="polite">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading protocols...</p>
                    </div>
                </div>
            </section>

            <section class="section" id="chains-section" aria-labelledby="chains-heading">
                <div class="section-header">
                    <h2 id="chains-heading"><span class="section-icon">‚õìÔ∏è</span> Top Growing Chains</h2>
                    <div class="section-controls" role="group" aria-label="Chains timeframe selection">
                        <button class="timeframe-btn active" data-section="chains" data-timeframe="1d" aria-pressed="true">24H</button>
                        <button class="timeframe-btn" data-section="chains" data-timeframe="7d" aria-pressed="false">7D</button>
                        <button class="timeframe-btn" data-section="chains" data-timeframe="30d" aria-pressed="false">1M</button>
                    </div>
                </div>
                <div class="table-container" id="chainsContainer" role="region" aria-live="polite">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading chains...</p>
                    </div>
                </div>
            </section>
        </div>

        <section class="section" id="categories-section" aria-labelledby="categories-heading">
            <div class="section-header">
                <h2 id="categories-heading"><span class="section-icon">üìä</span> Category Performance</h2>
                <div class="section-controls" role="group" aria-label="Categories timeframe selection">
                    <button class="timeframe-btn active" data-section="categories" data-timeframe="1d" aria-pressed="true">24H</button>
                    <button class="timeframe-btn" data-section="categories" data-timeframe="7d" aria-pressed="false">7D</button>
                    <button class="timeframe-btn" data-section="categories" data-timeframe="30d" aria-pressed="false">1M</button>
                </div>
            </div>
            <div class="table-container" id="categoriesContainer" role="region" aria-live="polite">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading categories...</p>
                </div>
            </div>
        </section>

        <p class="last-updated" id="lastUpdated"></p>

        <footer>
            <p>Data from <a href="https://defillama.com" target="_blank" rel="noopener noreferrer">DefiLlama API</a> ‚Ä¢ Built with ‚ù§Ô∏è for DeFi degens</p>
        </footer>
    </div>

    <script>
        'use strict';

        // ============ CONFIGURATION ============
        const CONFIG = Object.freeze({
            PROTOCOL_MIN_TVL: 1_000_000,
            CHAIN_MIN_TVL: 10_000_000,
            TOP_RESULTS: 50,
            TOP_SUB_RESULTS: 5,
            API_URL: 'https://api.llama.fi/protocols',
            TIMEFRAMES: Object.freeze({
                DAY: '1d',
                WEEK: '7d',
                MONTH: '30d'
            })
        });

        // Category icons mapping (emojis)
        const CATEGORY_ICONS = Object.freeze({
            'Dexes': 'üîÑ',
            'DEX': 'üîÑ',
            'Lending': 'üè¶',
            'CDP': 'üíµ',
            'Bridge': 'üåâ',
            'Derivatives': 'üìà',
            'Yield': 'üåæ',
            'Yield Aggregator': 'üåæ',
            'Liquid Staking': 'üíß',
            'Liquidity manager': 'üíß',
            'Services': 'üõ†Ô∏è',
            'Staking': 'ü•©',
            'Farm': 'üöú',
            'Reserve Currency': 'üí∞',
            'Algo-Stables': 'üî¢',
            'Insurance': 'üõ°Ô∏è',
            'Options': 'üìä',
            'Indexes': 'üìë',
            'Synthetics': 'üß™',
            'Gaming': 'üéÆ',
            'NFT Lending': 'üñºÔ∏è',
            'NFT Marketplace': 'üè™',
            'Payments': 'üí≥',
            'Privacy': 'üîí',
            'Launchpad': 'üöÄ',
            'Prediction Market': 'üéØ',
            'RWA': 'üè†',
            'RWA Lending': 'üè†',
            'Leveraged Farming': '‚ö°',
            'Cross Chain': 'üîó',
            'SoFi': 'üì±',
            'Oracle': 'üîÆ',
            'Other': 'üì¶'
        });

        // Chain name ‚Üí DefiLlama slug mapping
        const CHAIN_SLUGS = Object.freeze({
            'Ethereum': 'ethereum',
            'Tron': 'tron',
            'BSC': 'bsc',
            'BNB Chain': 'bsc',
            'Polygon': 'polygon',
            'Arbitrum': 'arbitrum',
            'Optimism': 'optimism',
            'Base': 'base',
            'Avalanche': 'avalanche',
            'Solana': 'solana',
            'Fantom': 'fantom',
            'zkSync Era': 'zksync-era',
            'Linea': 'linea',
            'Scroll': 'scroll',
            'Mantle': 'mantle',
            'Blast': 'blast',
            'Metis': 'metis',
            'Mode': 'mode',
            'Cronos': 'cronos',
            'Kava': 'kava',
            'Celo': 'celo',
            'Gnosis': 'gnosis',
            'Harmony': 'harmony',
            'Moonbeam': 'moonbeam',
            'Moonriver': 'moonriver',
            'Astar': 'astar',
            'Injective': 'injective',
            'Starknet': 'starknet',
            'Sui': 'sui',
            'Aptos': 'aptos',
            'Cardano': 'cardano',
            'TON': 'ton',
            'Near': 'near',
            'Cosmos': 'cosmos',
            'Osmosis': 'osmosis'
        });

        // ============ STATE ============
        const state = {
            rawProtocols: null,
            isLoading: false,
            expandedChains: new Set(),
            expandedCategories: new Set(),
            sectionTimeframes: {
                protocols: CONFIG.TIMEFRAMES.DAY,
                categories: CONFIG.TIMEFRAMES.DAY,
                chains: CONFIG.TIMEFRAMES.DAY
            },
            sortState: {
                protocols: { column: 'change', direction: 'desc' },
                chains: { column: 'change', direction: 'desc' },
                categories: { column: 'change', direction: 'desc' }
            },
            cache: {
                protocols: new Map(),
                chains: new Map(),
                categories: new Map()
            }
        };

        // ============ UTILITIES ============
        const escapeHtml = (() => {
            const div = document.createElement('div');
            return (text) => {
                div.textContent = text;
                return div.innerHTML;
            };
        })();

        function formatTVL(num) {
            if (!num || !Number.isFinite(num)) return '$0';
            if (num >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
            if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
            if (num >= 1e3) return `$${(num / 1e3).toFixed(2)}K`;
            return `$${num.toFixed(0)}`;
        }

        function formatPercent(num) {
            if (num === null || num === undefined || !Number.isFinite(num)) return 'N/A';
            const sign = num >= 0 ? '+' : '';
            return `${sign}${num.toFixed(2)}%`;
        }

        function getChangeClass(num) {
            if (num === null || num === undefined || !Number.isFinite(num)) return 'neutral';
            return num >= 0 ? 'positive' : 'negative';
        }

        function getChangeField(timeframe) {
            const fieldMap = {
                [CONFIG.TIMEFRAMES.DAY]: 'change_1d',
                [CONFIG.TIMEFRAMES.WEEK]: 'change_7d',
                [CONFIG.TIMEFRAMES.MONTH]: 'change_1m'
            };
            return fieldMap[timeframe] || 'change_1d';
        }

        function getTimeframeLabel(timeframe) {
            const labelMap = {
                [CONFIG.TIMEFRAMES.DAY]: '24H',
                [CONFIG.TIMEFRAMES.WEEK]: '7D',
                [CONFIG.TIMEFRAMES.MONTH]: '1M'
            };
            return labelMap[timeframe] || '24H';
        }

        function getCategoryIcon(category) {
            return CATEGORY_ICONS[category] || CATEGORY_ICONS['Other'];
        }

        function getCategorySlug(category) {
            return category.toLowerCase().replace(/\s+/g, '-').replace(/[^^a-z0-9-]/g, '');
        }

        function getChainSlug(chainName) {
            return CHAIN_SLUGS[chainName] || chainName.toLowerCase().replace(/\s+/g, '-');
        }

        function clearCache() {
            state.cache.protocols.clear();
            state.cache.chains.clear();
            state.cache.categories.clear();
        }

        // ============ DATA PROCESSING ============
        function processProtocols(protocols, timeframe) {
            const cacheKey = timeframe;
            if (state.cache.protocols.has(cacheKey)) {
                return state.cache.protocols.get(cacheKey);
            }

            const field = getChangeField(timeframe);
            const result = protocols
                .filter(p => p.tvl >= CONFIG.PROTOCOL_MIN_TVL && p[field] != null && Number.isFinite(p[field]))
                .map(p => ({
                    name: p.name,
                    slug: p.slug,
                    logo: p.logo || 'https://icons.llama.fi/missing.png',
                    tvl: p.tvl,
                    chains: p.chains || [],
                    change: p[field],
                    category: p.category || 'Other'
                }));

            state.cache.protocols.set(cacheKey, result);
            return result;
        }

        function processChains(protocols, timeframe) {
            const cacheKey = timeframe;
            if (state.cache.chains.has(cacheKey)) {
                return state.cache.chains.get(cacheKey);
            }

            const field = getChangeField(timeframe);
            const chainMap = new Map();

            protocols.forEach(p => {
                const chains = p.chains || [];
                const change = p[field];
                
                if (change == null || !Number.isFinite(change) || chains.length === 0) return;

                chains.forEach(chainName => {
                    // Use chainTvls if available for accurate per-chain TVL
                    let chainTvl;
                    if (p.chainTvls && p.chainTvls[chainName] != null && typeof p.chainTvls[chainName] === 'number') {
                        chainTvl = p.chainTvls[chainName];
                    } else if (chains.length === 1) {
                        // Single chain protocol - use full TVL
                        chainTvl = p.tvl;
                    } else {
                        // Multi-chain without specific data - distribute evenly as fallback
                        chainTvl = p.tvl / chains.length;
                    }
                    
                    if (!chainMap.has(chainName)) {
                        chainMap.set(chainName, {
                            name: chainName,
                            totalTvl: 0,
                            weightedChangeSum: 0,
                            protocolCount: 0
                        });
                    }

                    const chain = chainMap.get(chainName);
                    chain.totalTvl += chainTvl;
                    chain.weightedChangeSum += chainTvl * change;
                    chain.protocolCount += 1;
                });
            });

            const result = Array.from(chainMap.values())
                .filter(c => c.totalTvl >= CONFIG.CHAIN_MIN_TVL)
                .map(c => ({
                    name: c.name,
                    slug: getChainSlug(c.name),
                    tvl: c.totalTvl,
                    change: c.totalTvl > 0 ? c.weightedChangeSum / c.totalTvl : 0,
                    protocolCount: c.protocolCount
                }));

            state.cache.chains.set(cacheKey, result);
            return result;
        }

        function processCategories(protocols, timeframe) {
            const cacheKey = timeframe;
            if (state.cache.categories.has(cacheKey)) {
                return state.cache.categories.get(cacheKey);
            }

            const field = getChangeField(timeframe);
            const categoryMap = new Map();

            protocols
                .filter(p => p.tvl >= CONFIG.PROTOCOL_MIN_TVL && p[field] != null && Number.isFinite(p[field]))
                .forEach(p => {
                    const category = p.category || 'Other';
                    
                    if (!categoryMap.has(category)) {
                        categoryMap.set(category, {
                            name: category,
                            totalTvl: 0,
                            weightedChangeSum: 0,
                            protocolCount: 0
                        });
                    }

                    const cat = categoryMap.get(category);
                    cat.totalTvl += p.tvl;
                    cat.weightedChangeSum += p.tvl * p[field];
                    cat.protocolCount += 1;
                });

            const result = Array.from(categoryMap.values())
                .filter(cat => cat.totalTvl > 0)
                .map(cat => ({
                    name: cat.name,
                    tvl: cat.totalTvl,
                    change: cat.totalTvl > 0 ? cat.weightedChangeSum / cat.totalTvl : 0,
                    protocolCount: cat.protocolCount
                }));

            state.cache.categories.set(cacheKey, result);
            return result;
        }

        function getTopProtocolsForChain(chainName, timeframe, limit = CONFIG.TOP_SUB_RESULTS) {
            if (!state.rawProtocols) return [];
            const field = getChangeField(timeframe);
            
            return state.rawProtocols
                .filter(p => {
                    const chains = p.chains || [];
                    return chains.includes(chainName) && p.tvl >= CONFIG.PROTOCOL_MIN_TVL && p[field] != null && Number.isFinite(p[field]);
                })
                .map(p => ({
                    name: p.name,
                    slug: p.slug,
                    logo: p.logo || 'https://icons.llama.fi/missing.png',
                    tvl: p.tvl,
                    change: p[field],
                    category: p.category || 'Other'
                }))
                .sort((a, b) => b.change - a.change)
                .slice(0, limit);
        }

        function getTopProtocolsForCategory(categoryName, timeframe, limit = CONFIG.TOP_SUB_RESULTS) {
            if (!state.rawProtocols) return [];
            const field = getChangeField(timeframe);
            
            return state.rawProtocols
                .filter(p => {
                    const category = p.category || 'Other';
                    return category === categoryName && p.tvl >= CONFIG.PROTOCOL_MIN_TVL && p[field] != null && Number.isFinite(p[field]);
                })
                .map(p => ({
                    name: p.name,
                    slug: p.slug,
                    logo: p.logo || 'https://icons.llama.fi/missing.png',
                    tvl: p.tvl,
                    change: p[field],
                    category: p.category || 'Other'
                }))
                .sort((a, b) => b.change - a.change)
                .slice(0, limit);
        }

        // ============ SORTING ============
        function sortData(data, sortCol, sortDir) {
            return [...data].sort((a, b) => {
                let aVal = a[sortCol];
                let bVal = b[sortCol];

                if (sortCol === 'name' || sortCol === 'category') {
                    aVal = (aVal || '').toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                    if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
                    return 0;
                }

                aVal = aVal || 0;
                bVal = bVal || 0;
                return sortDir === 'asc' ? aVal - bVal : bVal - aVal;
            });
        }

        function getSortClass(currentCol, sortCol, sortDir) {
            if (currentCol !== sortCol) return '';
            return sortDir === 'asc' ? 'sort-asc' : 'sort-desc';
        }

        // ============ SUB-TABLE RENDERING ============
        function renderSubTable(protocols, title, timeframe) {
            if (protocols.length === 0) {
                return `<div class="no-data">No protocols found with significant TVL change</div>`;
            }

            const timeframeLabel = getTimeframeLabel(timeframe);

            const rows = protocols.map((p, i) => `
                <tr>
                    <td>#${i + 1}</td>
                    <td>
                        <div class="protocol-name">
                            <img class="protocol-logo" src="${escapeHtml(p.logo)}" alt="" loading="lazy" onerror="this.onerror=null; this.src='https://icons.llama.fi/missing.png'" style="width:22px;height:22px;">
                            <a href="https://defillama.com/protocol/${escapeHtml(p.slug)}" target="_blank" rel="noopener noreferrer">${escapeHtml(p.name)}</a>
                        </div>
                    </td>
                    <td class="tvl">${formatTVL(p.tvl)}</td>
                    <td><span class="change ${getChangeClass(p.change)}">${formatPercent(p.change)}</span></td>
                </tr>
            `).join('');

            return `
                <div class="sub-table-title">
                    <span>üìà</span> Top 5 TVL Gainers in <strong>${escapeHtml(title)}</strong> (${timeframeLabel})
                </div>
                <table class="sub-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Protocol</th>
                            <th>TVL</th>
                            <th>Change</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        // ============ MAIN TABLE RENDERING ============
        function renderProtocolsTable(data, sortCol, sortDir) {
            const sorted = sortData(data, sortCol, sortDir).slice(0, CONFIG.TOP_RESULTS);

            if (sorted.length === 0) {
                return '<div class="no-data">No protocols found matching criteria.</div>';
            }

            const rows = sorted.map((p, i) => `
                <tr>
                    <td class="rank">#${i + 1}</td>
                    <td>
                        <div class="protocol-name">
                            <img class="protocol-logo" src="${escapeHtml(p.logo)}" alt="" loading="lazy" onerror="this.onerror=null; this.src='https://icons.llama.fi/missing.png'">
                            <a href="https://defillama.com/protocol/${escapeHtml(p.slug)}" target="_blank" rel="noopener noreferrer">${escapeHtml(p.name)}</a>
                        </div>
                    </td>
                    <td class="tvl">${formatTVL(p.tvl)}</td>
                    <td><span class="change ${getChangeClass(p.change)}">${formatPercent(p.change)}</span></td>
                    <td>
                        <div class="chains-list">
                            ${p.chains.slice(0, 3).map(c => `<span class="chain-tag">${escapeHtml(c)}</span>`).join('')}
                            ${p.chains.length > 3 ? `<span class="chain-tag">+${p.chains.length - 3}</span>` : ''}
                        </div>
                    </td>
                    <td>${escapeHtml(p.category)}</td>
                </tr>
            `).join('');

            return `
                <table id="protocolsTable" role="grid">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th class="sortable ${getSortClass('name', sortCol, sortDir)}" data-col="name">Protocol</th>
                            <th class="sortable ${getSortClass('tvl', sortCol, sortDir)}" data-col="tvl">TVL</th>
                            <th class="sortable ${getSortClass('change', sortCol, sortDir)}" data-col="change">Change</th>
                            <th>Chains</th>
                            <th class="sortable ${getSortClass('category', sortCol, sortDir)}" data-col="category">Category</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function renderChainsTable(data, sortCol, sortDir, timeframe) {
            const sorted = sortData(data, sortCol, sortDir).slice(0, CONFIG.TOP_RESULTS);

            if (sorted.length === 0) {
                return '<div class="no-data">No chains found matching criteria.</div>';
            }

            const rows = sorted.map((c, i) => {
                const isExpanded = state.expandedChains.has(c.name);
                const topProtocols = isExpanded ? getTopProtocolsForChain(c.name, timeframe) : [];
                
                return `
                    <tr class="expandable-row ${isExpanded ? 'expanded' : ''}" 
                        data-chain="${escapeHtml(c.name)}" 
                        tabindex="0" 
                        role="button" 
                        aria-expanded="${isExpanded}">
                        <td class="rank">
                            <span class="expand-icon" aria-hidden="true">‚ñ∂</span>
                            #${i + 1}
                        </td>
                        <td>
                            <div class="chain-name">
                                <a href="https://defillama.com/chain/${escapeHtml(c.slug)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">${escapeHtml(c.name)}</a>
                            </div>
                        </td>
                        <td class="tvl">${formatTVL(c.tvl)}</td>
                        <td><span class="change ${getChangeClass(c.change)}">${formatPercent(c.change)}</span></td>
                        <td><span class="protocol-count">${c.protocolCount}</span></td>
                    </tr>
                    <tr class="expanded-content ${isExpanded ? 'show' : ''}" data-chain-content="${escapeHtml(c.name)}">
                        <td colspan="5">
                            <div class="sub-table-container">
                                ${isExpanded ? renderSubTable(topProtocols, c.name, timeframe) : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <table id="chainsTable" role="grid">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th class="sortable ${getSortClass('name', sortCol, sortDir)}" data-col="name">Chain</th>
                            <th class="sortable ${getSortClass('tvl', sortCol, sortDir)}" data-col="tvl">TVL</th>
                            <th class="sortable ${getSortClass('change', sortCol, sortDir)}" data-col="change">Change</th>
                            <th class="sortable ${getSortClass('protocolCount', sortCol, sortDir)}" data-col="protocolCount">Protocols</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function renderCategoriesTable(data, sortCol, sortDir, timeframe) {
            const sorted = sortData(data, sortCol, sortDir);
            const maxTvl = sorted.length > 0 ? Math.max(...sorted.map(c => c.tvl)) : 0;

            if (sorted.length === 0) {
                return '<div class="no-data">No categories found matching criteria.</div>';
            }

            const rows = sorted.map((c, i) => {
                const barWidth = maxTvl > 0 ? (c.tvl / maxTvl) * 100 : 0;
                const isExpanded = state.expandedCategories.has(c.name);
                const topProtocols = isExpanded ? getTopProtocolsForCategory(c.name, timeframe) : [];
                
                return `
                    <tr class="expandable-row ${isExpanded ? 'expanded' : ''}" 
                        data-category="${escapeHtml(c.name)}" 
                        tabindex="0" 
                        role="button" 
                        aria-expanded="${isExpanded}">
                        <td class="rank">
                            <span class="expand-icon" aria-hidden="true">‚ñ∂</span>
                            #${i + 1}
                        </td>
                        <td>
                            <div class="category-name">
                                <span class="category-icon" aria-hidden="true">${getCategoryIcon(c.name)}</span>
                                <a href="https://defillama.com/protocols/${getCategorySlug(c.name)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">
                                    ${escapeHtml(c.name)}
                                </a>
                            </div>
                        </td>
                        <td>
                            <div>
                                <span class="tvl">${formatTVL(c.tvl)}</span>
                                <div class="tvl-bar-container" aria-hidden="true">
                                    <div class="tvl-bar" style="width: ${barWidth}%"></div>
                                </div>
                            </div>
                        </td>
                        <td><span class="change ${getChangeClass(c.change)}">${formatPercent(c.change)}</span></td>
                        <td><span class="protocol-count">${c.protocolCount}</span></td>
                    </tr>
                    <tr class="expanded-content ${isExpanded ? 'show' : ''}" data-category-content="${escapeHtml(c.name)}">
                        <td colspan="5">
                            <div class="sub-table-container">
                                ${isExpanded ? renderSubTable(topProtocols, c.name, timeframe) : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <table id="categoriesTable" role="grid">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th class="sortable ${getSortClass('name', sortCol, sortDir)}" data-col="name">Category</th>
                            <th class="sortable ${getSortClass('tvl', sortCol, sortDir)}" data-col="tvl">Total TVL</th>
                            <th class="sortable ${getSortClass('change', sortCol, sortDir)}" data-col="change">Avg Change</th>
                            <th class="sortable ${getSortClass('protocolCount', sortCol, sortDir)}" data-col="protocolCount">Protocols</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        // ============ STATS UPDATE ============
        function updateStats() {
            if (!state.rawProtocols) return;

            // Always use 24H timeframe for stats (consistent baseline)
            const timeframe = CONFIG.TIMEFRAMES.DAY;
            
            const processedProtocols = processProtocols(state.rawProtocols, timeframe);
            const processedChains = processChains(state.rawProtocols, timeframe);
            const processedCategories = processCategories(state.rawProtocols, timeframe);

            // Sort to get top performers
            const sortedProtocols = sortData(processedProtocols, 'change', 'desc');
            const sortedChains = sortData(processedChains, 'change', 'desc');
            const sortedCategories = sortData(processedCategories, 'change', 'desc');

            // Update counts
            document.getElementById('totalProtocols').textContent = processedProtocols.length.toLocaleString();
            document.getElementById('totalChains').textContent = processedChains.length.toLocaleString();
            document.getElementById('totalCategories').textContent = processedCategories.length.toLocaleString();

            // Update top performers with names
            if (sortedProtocols.length > 0) {
                document.getElementById('topGrowth').textContent = formatPercent(sortedProtocols[0].change);
                document.getElementById('topProtocolName').textContent = sortedProtocols[0].name;
            } else {
                document.getElementById('topGrowth').textContent = '-';
                document.getElementById('topProtocolName').textContent = '-';
            }

            if (sortedChains.length > 0) {
                document.getElementById('topChainGrowth').textContent = formatPercent(sortedChains[0].change);
                document.getElementById('topChainName').textContent = sortedChains[0].name;
            } else {
                document.getElementById('topChainGrowth').textContent = '-';
                document.getElementById('topChainName').textContent = '-';
            }

            if (sortedCategories.length > 0) {
                document.getElementById('topCategoryGrowth').textContent = formatPercent(sortedCategories[0].change);
                document.getElementById('topCategoryName').textContent = sortedCategories[0].name;
            } else {
                document.getElementById('topCategoryGrowth').textContent = '-';
                document.getElementById('topCategoryName').textContent = '-';
            }
        }

        // ============ SECTION RENDER FUNCTIONS ============
        function renderProtocolsSection() {
            if (!state.rawProtocols) return;
            
            const timeframe = state.sectionTimeframes.protocols;
            const processedProtocols = processProtocols(state.rawProtocols, timeframe);
            
            document.getElementById('protocolsContainer').innerHTML = renderProtocolsTable(
                processedProtocols,
                state.sortState.protocols.column,
                state.sortState.protocols.direction
            );
        }

        function renderChainsSection() {
            if (!state.rawProtocols) return;
            
            const timeframe = state.sectionTimeframes.chains;
            const processedChains = processChains(state.rawProtocols, timeframe);
            
            document.getElementById('chainsContainer').innerHTML = renderChainsTable(
                processedChains,
                state.sortState.chains.column,
                state.sortState.chains.direction,
                timeframe
            );
        }

        function renderCategoriesSection() {
            if (!state.rawProtocols) return;
            
            const timeframe = state.sectionTimeframes.categories;
            const processedCategories = processCategories(state.rawProtocols, timeframe);
            
            document.getElementById('categoriesContainer').innerHTML = renderCategoriesTable(
                processedCategories,
                state.sortState.categories.column,
                state.sortState.categories.direction,
                timeframe
            );
        }

        function renderAll() {
            renderProtocolsSection();
            renderChainsSection();
            renderCategoriesSection();
            updateStats();
        }

        // ============ EVENT HANDLERS ============
        function handleSortClick(e, section, renderFn) {
            const th = e.target.closest('th.sortable');
            if (!th) return false;

            const col = th.dataset.col;
            const sortState = state.sortState[section];
            const isSameColumn = sortState.column === col;
            
            sortState.direction = isSameColumn && sortState.direction === 'desc' ? 'asc' : 'desc';
            sortState.column = col;
            renderFn();
            return true;
        }

        function handleExpandableRowClick(e, expandedSet, renderFn, dataAttr) {
            const row = e.target.closest('.expandable-row');
            if (!row || e.target.closest('a')) return false;

            const key = row.dataset[dataAttr];
            if (!key) return false;

            if (expandedSet.has(key)) {
                expandedSet.delete(key);
            } else {
                expandedSet.add(key);
            }
            renderFn();
            return true;
        }

        function handleKeyboardExpand(e, expandedSet, renderFn, dataAttr) {
            if (e.key !== 'Enter' && e.key !== ' ') return;
            
            const row = e.target.closest('.expandable-row');
            if (!row) return;

            e.preventDefault();
            const key = row.dataset[dataAttr];
            if (!key) return;

            if (expandedSet.has(key)) {
                expandedSet.delete(key);
            } else {
                expandedSet.add(key);
            }
            renderFn();
        }

        // Protocols container events
        document.getElementById('protocolsContainer').addEventListener('click', e => {
            handleSortClick(e, 'protocols', renderProtocolsSection);
        });

        // Chains container events
        document.getElementById('chainsContainer').addEventListener('click', e => {
            if (handleSortClick(e, 'chains', renderChainsSection)) return;
            handleExpandableRowClick(e, state.expandedChains, renderChainsSection, 'chain');
        });

        document.getElementById('chainsContainer').addEventListener('keydown', e => {
            handleKeyboardExpand(e, state.expandedChains, renderChainsSection, 'chain');
        });

        // Categories container events
        document.getElementById('categoriesContainer').addEventListener('click', e => {
            if (handleSortClick(e, 'categories', renderCategoriesSection)) return;
            handleExpandableRowClick(e, state.expandedCategories, renderCategoriesSection, 'category');
        });

        document.getElementById('categoriesContainer').addEventListener('keydown', e => {
            handleKeyboardExpand(e, state.expandedCategories, renderCategoriesSection, 'category');
        });

        // Timeframe button handlers
        document.querySelectorAll('.timeframe-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const section = btn.dataset.section;
                const timeframe = btn.dataset.timeframe;

                // Update active state and aria-pressed for this section's buttons
                document.querySelectorAll(`.timeframe-btn[data-section="${section}"]`).forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-pressed', 'false');
                });
                btn.classList.add('active');
                btn.setAttribute('aria-pressed', 'true');

                // Update timeframe state
                state.sectionTimeframes[section] = timeframe;

                // Reset sort to change desc when switching timeframe
                state.sortState[section] = { column: 'change', direction: 'desc' };

                // Re-render only the affected section
                switch (section) {
                    case 'protocols':
                        renderProtocolsSection();
                        break;
                    case 'chains':
                        renderChainsSection();
                        break;
                    case 'categories':
                        renderCategoriesSection();
                        break;
                }
            });
        });

        // ============ DATA LOADING ============
        async function loadData(forceRefresh = false) {
            if (state.isLoading) return;

            const containers = ['protocolsContainer', 'chainsContainer', 'categoriesContainer'];
            const refreshBtn = document.getElementById('refreshBtn');

            try {
                state.isLoading = true;
                refreshBtn.disabled = true;
                refreshBtn.textContent = '‚Üª Loading...';

                if (!state.rawProtocols || forceRefresh) {
                    const loadingHtml = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading data from DefiLlama...</p>
                        </div>
                    `;
                    containers.forEach(id => {
                        document.getElementById(id).innerHTML = loadingHtml;
                    });

                    // Clear state on refresh
                    state.expandedChains.clear();
                    state.expandedCategories.clear();
                    clearCache();

                    const response = await fetch(CONFIG.API_URL);

                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                    }

                    state.rawProtocols = await response.json();

                    if (!Array.isArray(state.rawProtocols)) {
                        throw new Error('Invalid data format received from API');
                    }
                }

                renderAll();
                document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;

            } catch (err) {
                console.error('Load error:', err);
                const errorHtml = `
                    <div class="error">
                        <p>Failed to load data: ${escapeHtml(err.message)}</p>
                        <button class="retry-btn" onclick="loadData(true)">‚Üª Retry</button>
                    </div>
                `;
                containers.forEach(id => {
                    document.getElementById(id).innerHTML = errorHtml;
                });
            } finally {
                state.isLoading = false;
                refreshBtn.disabled = false;
                refreshBtn.textContent = '‚Üª Refresh Data';
            }
        }

        // ============ REFRESH BUTTON ============
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadData(true);
        });

        // ============ INIT ============
        loadData();
    </script>
</body>
</html>
